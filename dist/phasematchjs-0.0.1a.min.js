(function(t,a){"object"==typeof exports?module.exports=a(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],a):t.PhaseMatch=a(t.numeric)})(this,function(t){"use strict";function a(t){return t*t}var i={},s=Math.pow(10,-9),h=Math.pow(10,-6),n=2.99792458*Math.pow(10,8);return i.constants={um:h,nm:s,c:n},i.BBO=function(t){this.temp=t},i.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var i=Math.sqrt(2.7359+.01878/(a(t)-.01822)-.01354*a(t)),s=Math.sqrt(2.3753+.01224/(a(t)-.01667)-.01516*a(t));return[i,i,s]}},i.GetIndices=function(t,i,s,h,n,e){var o=t.indicies(i),c=o[0],M=o[1],r=o[2],p=Math.sin(n)*Math.cos(e),u=Math.sin(n)*Math.sin(e),d=Math.cos(n),f=Math.cos(s)*Math.cos(h)*p-Math.sin(h)*u+Math.sin(s)*Math.cos(h)*d,_=Math.cos(s)*Math.sin(h)*p+Math.cos(h)*u+Math.sin(s)*Math.sin(h)*d,m=-Math.sin(s)*p+Math.cos(s)*d,l=Math.sqrt(a(p)+a(u)+a(d)),v=f/l,y=_/l,w=m/l,I=a(v)*(1/a(M)+1/a(r))+a(y)*(1/a(c)+1/a(r))+a(w)*(1/a(c)+1/a(M)),P=a(v)/(a(M)*a(r))+a(y)/(a(c)*a(r))+a(w)/(a(c)*a(M)),b=a(I)-4*P,q=Math.sqrt(2/(I+Math.sqrt(b))),S=Math.sqrt(2/(I-Math.sqrt(b)));return[S,q]},i.GetPMTypeIndices=function(t,a,s,h,n,e,o,c,M,r,p){var u,d,f,_=i.GetIndices(t,h,e,o,c,r),m=i.GetIndices(t,n,e,o,M,p),l=i.GetIndices(t,s,e,o,0,0);switch(a){case"e -> o + o":u=_[0],d=m[0],f=l[1];break;case"e -> e + o":u=_[1],d=m[0],f=l[1];break;case"e -> o + e":u=_[0],d=m[1],f=l[1];break;default:throw"Error: bad PMType specified"}return[u,d,f]},i.spdc_to_pump_coordinates=function(t,a){return[Math.sin(t)*Math.cos(a),Math.sin(t)*Math.sin(a),Math.cos(t)]},i.calc_delK=function(t,a,s,h,n,e,o,c,M,r,p,u){var d=i.GetPMTypeIndices(t,a,s,h,n,e,o,c,M,r,p),f=d[0],_=d[1],m=d[2],l=[Math.sin(c)*Math.cos(r),Math.sin(c)*Math.sin(r),Math.cos(c)],v=[Math.sin(M)*Math.cos(p),Math.sin(M)*Math.sin(p),Math.cos(M)],y=2*Math.PI*(f*l[0]/h+_*v[0]/n),w=2*Math.PI*(f*l[1]/h+_*v[1]/n),I=2*Math.PI*(m/s-f*l[2]/h-_*v[2]/n);return I-=2*Math.PI/u,[y,w,I]},i.optimum_idler=function(t,s,h,n,e,o,c,M,r){var p=1/(1/h-1/n),u=o+Math.PI,d=n/r,f=i.GetPMTypeIndices(t,s,h,n,p,c,M,e,e,o,u),_=f[0];f[1];var m=f[2],l=a(_)+a(m*n/h);l-=2*_*m*(n/h)*Math.cos(e)-2*m*n/h*d,l+=2*_*Math.cos(e)*d+a(d),l=Math.sqrt(l);var v=_*Math.sin(e)/l,y=Math.asin(v);return y},i.phasematch=function(t,s,h,n,e,o,c,M,r,p,u,d,f,_,m){var l=1/(1/o+1/c),v=i.calc_delK(t,s,l,o,c,r,p,u,d,f,_,m),y=M/2*v[2],w=Math.sin(y)/y,I=w*Math.cos(y),P=w*Math.sin(y),b=Math.exp(-.5*(a(v[0])+a(v[1]))*a(e)),q=1;return[q*b*I,q*b*P]},i.phasematch_Int_Phase=function(t,s,h,n,e,o,c,M,r,p,u,d,f,_,m,l,v,y){var w=i.phasematch(t,s,h,n,e,o,c,M,r,p,u,d,f,_,m,l,v,y);return l?Math.atan2(w[1],w[0])+Math.PI:w=a(w[0])+a(w[1]),w},function(){var t=function(){this.Sx=0,this.Sy=0,this.Sz=0};t.prototype={set:function(t,i,s,h){var n=Math.sin(s)*Math.cos(h),e=Math.sin(s)*Math.sin(h),o=Math.cos(s),c=Math.cos(t)*Math.cos(i)*n-Math.sin(i)*e+Math.sin(t)*Math.cos(i)*o,M=Math.cos(t)*Math.sin(i)*n+Math.cos(i)*e+Math.sin(t)*Math.sin(i)*o,r=-Math.sin(t)*n+Math.cos(t)*o,p=Math.sqrt(a(n)+a(e)+a(o));this.Sx=c/p,this.Sy=M/p,this.Sz=r/p}},i.Rotation=t;var s=function(){this.init()};s.prototype={init:function(){var t=i.constants;this.lambda_p=775*t.nm,this.lambda_s=1500*t.nm,this.lambda_i=1600*t.nm,this.Type=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.xtal=new i.BBO},set:function(t,a){switch(t){case"lambda_p":}this[t]=a}},i.SPDCprop=s}(),i.calcJSA=function(a,s,h,n,e,o){var c,M=new Float64Array(o),r=new Float64Array(o);M=t.linspace(s,h,o),r=t.linspace(e,n,o);var p=new Float64Array(o*o),u=o*o;for(new Date,c=0;u>c;c++){var d=c%o,f=Math.floor(c/o);p[c]=i.phasematch_Int_Phase(a.xtal,a.Type[1],a.lambda_p,a.p_bw,a.W,M[d],r[f],a.L,a.theta,a.phi,a.theta_s,a.theta_i,a.phi_s,a.phi_i,a.poling_period,a.phase,a.apodization,a.apodization_FWHM)}return new Date,p},i.linspace=function(t,a,i){for(var s=(a-t)/i,h=new Float64Array(i),n=0;i>n;n++)h[n]=t+s*n;return h},i});