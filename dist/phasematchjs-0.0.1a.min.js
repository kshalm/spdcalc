(function(t,a){"object"==typeof exports?module.exports=a(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],a):t.PhaseMatch=a(t.numeric)})(this,function(t){"use strict";function a(t){return t*t}var i={},s=Math.pow(10,-9),h=Math.pow(10,-6),e=2.99792458*Math.pow(10,8);return i.constants={um:h,nm:s,c:e},i.BBO=function(t){this.temp=t},i.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var i=Math.sqrt(2.7359+.01878/(a(t)-.01822)-.01354*a(t)),s=Math.sqrt(2.3753+.01224/(a(t)-.01667)-.01516*a(t));return[i,i,s]}},i.GetIndices=function(t,i,s,h,e,n){var r=t.indicies(i),c=r[0],o=r[1],_=r[2],p=Math.sin(e)*Math.cos(n),M=Math.sin(e)*Math.sin(n),d=Math.cos(e),l=Math.cos(s)*Math.cos(h)*p-Math.sin(h)*M+Math.sin(s)*Math.cos(h)*d,m=Math.cos(s)*Math.sin(h)*p+Math.cos(h)*M+Math.sin(s)*Math.sin(h)*d,u=-Math.sin(s)*p+Math.cos(s)*d,b=Math.sqrt(a(p)+a(M)+a(d)),y=l/b,f=m/b,T=u/b,I=a(y)*(1/a(o)+1/a(_))+a(f)*(1/a(c)+1/a(_))+a(T)*(1/a(c)+1/a(o)),P=a(y)/(a(o)*a(_))+a(f)/(a(c)*a(_))+a(T)/(a(c)*a(o)),v=a(I)-4*P,w=Math.sqrt(2/(I+Math.sqrt(v))),q=Math.sqrt(2/(I-Math.sqrt(v)));return[q,w]},i.GetPMTypeIndices=function(t){var a,s,h,e=i.GetIndices(t.crystal,t.lambda_s,t.theta,t.phi,t.theta_s,t.phi_s),n=i.GetIndices(t.crystal,t.lambda_i,t.theta,t.phi,t.theta_i,t.phi_i),r=i.GetIndices(t.crystal,t.lambda_p,t.theta,t.phi,0,0);switch(t.Type){case"e -> o + o":a=e[0],s=n[0],h=r[1];break;case"e -> e + o":a=e[1],s=n[0],h=r[1];break;case"e -> o + e":a=e[0],s=n[1],h=r[1];break;default:throw"Error: bad PMType specified"}return[a,s,h]},i.spdc_to_pump_coordinates=function(t,a){return[Math.sin(t)*Math.cos(a),Math.sin(t)*Math.sin(a),Math.cos(t)]},i.calc_delK=function(t){var a=i.GetPMTypeIndices(t),s=a[0],h=a[1],e=a[2],n=[Math.sin(t.theta_s)*Math.cos(t.phi_s),Math.sin(t.theta_s)*Math.sin(t.phi_s),Math.cos(t.theta_s)],r=[Math.sin(t.theta_i)*Math.cos(t.phi_i),Math.sin(t.theta_i)*Math.sin(t.phi_i),Math.cos(t.theta_i)],c=2*Math.PI*(s*n[0]/t.lambda_s+h*r[0]/t.lambda_i),o=2*Math.PI*(s*n[1]/t.lambda_s+h*r[1]/t.lambda_i),_=2*Math.PI*(e/t.lambda_p-s*n[2]/t.lambda_s-h*r[2]/t.lambda_i);return _-=2*Math.PI/t.poling_period,[c,o,_]},i.optimum_idler=function(t,s,h,e,n,r,c,o,_){var p=1/(1/h-1/e),M=r+Math.PI,d=e/_,l=i.GetPMTypeIndices(t,s,h,e,p,c,o,n,n,r,M),m=l[0];l[1];var u=l[2],b=a(m)+a(u*e/h);b-=2*m*u*(e/h)*Math.cos(n)-2*u*e/h*d,b+=2*m*Math.cos(n)*d+a(d),b=Math.sqrt(b);var y=m*Math.sin(n)/b,f=Math.asin(y);return f},i.phasematch=function(t){t.lambda_p,t.n_p,t.lambda_p=1/(1/t.lambda_s+1/t.lambda_i),t.calc_Index_PMType(t.lambda_p,t.Type,t.S_p,"pump");var s=i.calc_delK(t),h=t.L/2*s[2],e=Math.sin(h)/h,n=e*Math.cos(h),r=e*Math.sin(h),c=Math.exp(-.5*(a(s[0])+a(s[1]))*a(t.W)),o=1;return[o*c*n,o*c*r]},i.phasematch_Int_Phase=function(t){var s=i.phasematch(t,t.crystal,t.Type,t.lambda_p,t.p_bw,t.W,t.lambda_s,t.lambda_i,t.L,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i,t.poling_period,t.phase,t.apodization,t.apodization_FWHM);return t.phase?Math.atan2(s[1],s[0])+Math.PI:s=a(s[0])+a(s[1]),s},function(){var t=function(){this.init()};t.prototype={init:function(){var t=i.constants;this.lambda_p=775*t.nm,this.lambda_s=1550*t.nm,this.lambda_i=1550*t.nm,this.Types=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.Type=this.Types[1],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.crystal=new i.BBO,this.calc_Coordinate_Transform=function(t,i,s,h){var e=Math.sin(t),n=Math.cos(t),r=Math.sin(s),c=Math.cos(s),o=Math.sin(i),_=Math.cos(i),p=Math.sin(h),M=Math.cos(h),d=r*M,l=r*p,m=c,u=n*_*d-o*l+e*_*m,b=n*o*d+_*l+e*o*m,y=-e*d+n*m,f=Math.sqrt(a(d)+a(l)+a(m)),T=u/f,I=b/f,P=y/f;return[T,I,P]},this.calc_Index_PMType=function(t,i,s,h){var e=this.crystal.indicies(t),n=e[0],r=e[1],c=e[2],o=s[0],_=s[1],p=s[2],M=a(o)*(1/a(r)+1/a(c))+a(_)*(1/a(n)+1/a(c))+a(p)*(1/a(n)+1/a(r)),d=a(o)/(a(r)*a(c))+a(_)/(a(n)*a(c))+a(p)/(a(n)*a(r)),l=a(M)-4*d,m=Math.sqrt(2/(M+Math.sqrt(l))),u=Math.sqrt(2/(M-Math.sqrt(l))),b=1;switch(i){case"e -> o + o":b="pump"===h?m:u;break;case"e -> e + o":b="idler"===h?u:m;break;case"e -> o + e":b="signal"===h?u:m;break;default:throw"Error: bad PMType specified"}return b},this.S_p=this.calc_Coordinate_Transform(this.theta,this.phi,0,0),this.S_s=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_s,this.phi_s),this.S_i=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_i,this.phi_i),this.n_p=this.calc_Index_PMType(this.lambda_p,this.Type,this.S_p,"pump"),this.n_s=this.calc_Index_PMType(this.lambda_s,this.Type,this.S_s,"signal"),this.n_i=this.calc_Index_PMType(this.lambda_i,this.Type,this.S_i,"idler")},set:function(t,a){switch(t){case"lambda_p":}this[t]=a}},i.SPDCprop=t}(),i.calcJSA=function(a,s,h,e,n,r){var c,o=new Float64Array(r),_=new Float64Array(r);o=t.linspace(s,h,r),_=t.linspace(n,e,r);var p=new Float64Array(r*r),M=r*r;for(new Date,c=0;M>c;c++){var d=c%r,l=Math.floor(c/r);a.lambda_s=o[d],a.lambda_i=_[l],a.n_s=a.calc_Index_PMType(a.lambda_s,a.Type,a.S_s,"signal"),a.n_i=a.calc_Index_PMType(a.lambda_i,a.Type,a.S_i,"idler"),p[c]=i.phasematch_Int_Phase(a)}return new Date,p},i});