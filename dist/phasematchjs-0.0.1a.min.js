(function(t,a){"object"==typeof exports?module.exports=a(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],a):t.PhaseMatch=a(t.numeric)})(this,function(){"use strict";function t(t){return t*t}var a={},i=Math.pow(10,-9),n=Math.pow(10,-6),e=2.99792458*Math.pow(10,8);return a.constants={um:n,nm:i,c:e},a.BBO=function(t){this.temp=t},a.BBO.prototype={indicies:function(a){a*=Math.pow(10,6);var i=Math.sqrt(2.7359+.01878/(t(a)-.01822)-.01354*t(a)),n=Math.sqrt(2.3753+.01224/(t(a)-.01667)-.01516*t(a));return[i,i,n]}},a.GetIndices=function(a,i,n,e,h,s){var o=Math.sin(h)*Math.cos(s),r=Math.sin(h)*Math.sin(s),c=Math.cos(h),M=Math.cos(n)*Math.cos(e)*o-Math.sin(e)*r+Math.sin(n)*Math.cos(e)*c,p=Math.cos(n)*Math.sin(e)*o+Math.cos(e)*r+Math.sin(n)*Math.sin(e)*c,u=-Math.sin(n)*o+Math.cos(n)*c,d=Math.sqrt(t(o)+t(r)+t(c)),f=M/d,_=p/d,m=u/d,l=a.indicies(i),v=l[0],I=l[1],w=l[2],P=t(f)*(1/t(I)+1/t(w))+t(_)*(1/t(v)+1/t(w))+t(m)*(1/t(v)+1/t(I)),y=t(f)/(t(I)*t(w))+t(_)/(t(v)*t(w))+t(m)/(t(v)*t(I)),b=t(P)-4*y,q=Math.sqrt(2/(P+Math.sqrt(b))),G=Math.sqrt(2/(P-Math.sqrt(b)));return[G,q]},a.GetPMTypeIndices=function(t,i,n,e,h,s,o,r,c,M,p){var u,d,f,_=a.GetIndices(t,e,s,o,r,M),m=a.GetIndices(t,h,s,o,c,p),l=a.GetIndices(t,n,s,o,0,0);switch(i){case"e -> o + o":u=_[0],d=m[0],f=l[1];break;case"e -> e + o":u=_[1],d=m[0],f=l[1];break;case"e -> o + e":u=_[0],d=m[1],f=l[1];break;default:throw"Error: bad PMType specified"}return[u,d,f]},a.spdc_to_pump_coordinates=function(t,a){return[Math.sin(t)*Math.cos(a),Math.sin(t)*Math.sin(a),Math.cos(t)]},a.calc_delK=function(t,i,n,e,h,s,o,r,c,M,p,u){var d=a.GetPMTypeIndices(t,i,n,e,h,s,o,r,c,M,p),f=d[0],_=d[1],m=d[2],l=[Math.sin(r)*Math.cos(M),Math.sin(r)*Math.sin(M),Math.cos(r)],v=[Math.sin(c)*Math.cos(p),Math.sin(c)*Math.sin(p),Math.cos(c)],I=2*Math.PI*(f*l[0]/e+_*v[0]/h),w=2*Math.PI*(f*l[1]/e+_*v[1]/h),P=2*Math.PI*(m/n-f*l[2]/e-_*v[2]/h);return P-=2*Math.PI/u,[I,w,P]},a.optimum_idler=function(i,n,e,h,s,o,r,c,M){var p=1/(1/e-1/h),u=o+Math.PI,d=h/M,f=a.GetPMTypeIndices(i,n,e,h,p,r,c,s,s,o,u),_=f[0];f[1];var m=f[2],l=t(_)+t(m*h/e);l-=2*_*m*(h/e)*Math.cos(s)-2*m*h/e*d,l+=2*_*Math.cos(s)*d+t(d),l=Math.sqrt(l);var v=_*Math.sin(s)/l,I=Math.asin(v);return I},a.phasematch=function(i,n,e,h,s,o,r,c,M,p,u,d,f,_,m){var l=1/(1/o+1/r),v=a.calc_delK(i,n,l,o,r,M,p,u,d,f,_,m),I=c/2*v[2],w=Math.sin(I)/I,P=w*Math.cos(I),y=w*Math.sin(I),b=Math.exp(-.5*(t(v[0])+t(v[1]))*t(s)),q=1;return[q*b*P,q*b*y]},a.phasematch_Int_Phase=function(i,n,e,h,s,o,r,c,M,p,u,d,f,_,m,l,v,I){var w=a.phasematch(i,n,e,h,s,o,r,c,M,p,u,d,f,_,m,l,v,I);return l?Math.atan2(w[1],w[0])+Math.PI:w=t(w[0])+t(w[1]),w},function(){var t=function(){this.init()};t.prototype={init:function(){var t=a.constants;this.lambda_p=775*t.nm,this.lambda_s=1500*t.nm,this.lambda_i=1600*t.nm,this.Type=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.xtal=new a.BBO}},a.SPDCprop=t}(),a.calcJSA=function(t,i,n,e,h,s){var o,r=new Float64Array(s),c=new Float64Array(s);r=a.linspace(i,n,s),c=a.linspace(h,e,s);var M=new Float64Array(s*s),p=s*s;for(new Date,o=0;p>o;o++){var u=o%s,d=Math.floor(o/s);M[o]=a.phasematch_Int_Phase(t.xtal,t.Type[1],t.lambda_p,t.p_bw,t.W,r[u],c[d],t.L,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i,t.poling_period,t.phase,t.apodization,t.apodization_FWHM)}return new Date,M},a.linspace=function(t,a,i){for(var n=(a-t)/i,e=new Float64Array(i),h=0;i>h;h++)e[h]=t+n*h;return e},a});