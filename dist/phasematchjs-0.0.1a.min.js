(function(t,e){"object"==typeof exports?module.exports=e(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],e):t.PhaseMatch=e(t.numeric)})(this,function(t){"use strict";function e(t){return t*t}var n={util:{}};(function(){function t(){}function e(t,e,n,r){function i(){var r=arguments,c=o?this:e;if(s||(t=e[h]),n.length&&(r=r.length?(r=L.call(r),p?r.concat(n):n.concat(r)):n),this instanceof i){a.prototype=t.prototype,c=new a,a.prototype=null;var u=t.apply(c,r);return l(u)?u:c}return t.apply(c,r)}var s=c(t),o=!n,h=e;if(o){var p=r;n=e}else if(!s){if(!r)throw new TypeError;e=t}return i}function r(){for(var e,n={shadowedProps:_,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!K},r=0;e=arguments[r];r++)for(var i in e)n[i]=e[i];var a=n.args;n.firstArg=/^[^,]+/.exec(a)[0];var o=Function("hasOwnProperty, isArguments, isArray, keys, lodash, objectTypes","return function("+a+") {\n"+H(n)+"\n}");return o(O,s,D,K,t,j)}function i(t){return"function"!=typeof t.toString&&"string"==typeof(t+"")}function a(){}function s(t){return k.call(t)==b}function o(e,n,r,a,l,h){var p=r===d;if("function"==typeof r&&!p){r=t.createCallback(r,a,2);var u=r(e,n);if(u!==undefined)return!!u}if(e===n)return 0!==e||1/e==1/n;var f=typeof e,_=typeof n;if(e===e&&(!e||"function"!=f&&"object"!=f)&&(!n||"function"!=_&&"object"!=_))return!1;if(null==e||null==n)return e===n;var v=k.call(e),j=k.call(n);if(v==b&&(v=M),j==b&&(j=M),v!=j)return!1;switch(v){case y:case m:return+e==+n;case x:return e!=+e?n!=+n:0==e?1/e==1/n:e==+n;case w:case P:return e==n+""}var T=v==g;if(!T){if(O.call(e,"__wrapped__ ")||O.call(n,"__wrapped__"))return o(e.__wrapped__||e,n.__wrapped__||n,r,a,l,h);if(v!=M||!F.nodeClass&&(i(e)||i(n)))return!1;var I=!F.argsObject&&s(e)?Object:e.constructor,C=!F.argsObject&&s(n)?Object:n.constructor;if(I!=C&&!(c(I)&&I instanceof I&&c(C)&&C instanceof C))return!1}l||(l=[]),h||(h=[]);for(var A=l.length;A--;)if(l[A]==e)return h[A]==n;var S=0;if(u=!0,l.push(e),h.push(n),T){if(A=e.length,S=n.length,u=S==e.length,!u&&!p)return u;for(;S--;){var E=A,L=n[S];if(p)for(;E--&&!(u=o(e[E],L,r,a,l,h)););else if(!(u=o(e[S],L,r,a,l,h)))break}return u}return $(n,function(t,n,i){return O.call(i,n)?(S++,u=O.call(e,n)&&o(e[n],t,r,a,l,h)):undefined}),u&&!p&&$(e,function(t,e,n){return O.call(n,e)?u=--S>-1:undefined}),u}function c(t){return"function"==typeof t}function l(t){return t?j[typeof t]:!1}function h(t,n){return F.fastBind||A&&arguments.length>2?A.call.apply(A,arguments):e(t,n,L.call(arguments,2))}function p(t,e,n){if(null==t)return u;var r=typeof t;if("function"!=r){if("object"!=r)return function(e){return e[t]};var i=K(t);return function(e){for(var n=i.length,r=!1;n--&&(r=o(e[i[n]],t[i[n]],d)););return r}}return e!==undefined?1===n?function(n){return t.call(e,n)}:2===n?function(n,r){return t.call(e,n,r)}:4===n?function(n,r,i,a){return t.call(e,n,r,i,a)}:function(n,r,i){return t.call(e,n,r,i)}:t}function u(t){return t}var f="object"==typeof global&&global;(f.global===f||f.window===f)&&(window=f);var d={};+new Date+"";var _=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],b="[object Arguments]",g="[object Array]",y="[object Boolean]",m="[object Date]",v="[object Function]",x="[object Number]",M="[object Object]",w="[object RegExp]",P="[object String]",j={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},T=[],I={};window._;var C=RegExp("^"+(I.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),O=(Math.ceil,window.clearTimeout,T.concat,Math.floor,I.hasOwnProperty),k=(T.push,window.setTimeout,I.toString),A=C.test(A=k.bind)&&A,S=C.test(S=Array.isArray)&&S,E=(window.isFinite,window.isNaN,C.test(E=Object.keys)&&E),L=(Math.max,Math.min,Math.random,T.slice),B=C.test(window.attachEvent),q=A&&!/\n|true/.test(A+B),F=t.support={};(function(){var t=function(){this.x=1},e=[];t.prototype={valueOf:1,y:1};for(var n in new t)e.push(n);for(n in arguments);F.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),F.argsClass=s(arguments),F.enumPrototypes=t.propertyIsEnumerable("prototype"),F.fastBind=A&&!q,F.nonEnumArgs=0!=n,F.nonEnumShadows=!/valueOf/.test(e),F.unindexedChars="xx"!="x"[0]+Object("x")[0];try{F.nodeClass=!(k.call(document)==M&&!({toString:0}+""))}catch(r){F.nodeClass=!0}})(1);var H=function(t){var e="var index, iterable = "+t.firstArg+", result = "+t.init+";\nif (!iterable) return result;\n"+t.top+";\n";if(t.arrays?(e+="var length = iterable.length; index = -1;\nif ("+t.arrays+") {  ",F.unindexedChars&&(e+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),e+="\n  while (++index < length) {\n    "+t.loop+"\n  }\n}\nelse {  "):F.nonEnumArgs&&(e+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+t.loop+"\n    }\n  } else {  "),F.enumPrototypes&&(e+="\n  var skipProto = typeof iterable == 'function';\n  "),t.useHas&&t.useKeys)e+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",F.enumPrototypes&&(e+="if (!(skipProto && index == 'prototype')) {\n  "),e+=t.loop,F.enumPrototypes&&(e+="}\n"),e+="  }  ";else if(e+="\n  for (index in iterable) {",(F.enumPrototypes||t.useHas)&&(e+="\n    if (",F.enumPrototypes&&(e+="!(skipProto && index == 'prototype')"),F.enumPrototypes&&t.useHas&&(e+=" && "),t.useHas&&(e+="hasOwnProperty.call(iterable, index)"),e+=") {    "),e+=t.loop+";    ",(F.enumPrototypes||t.useHas)&&(e+="\n    }"),e+="\n  }    ",F.nonEnumShadows){e+="\n\n  var ctor = iterable.constructor;\n      ";for(var n=0;7>n;n++)e+="\n  index = '"+t.shadowedProps[n]+"';\n  if (","constructor"==t.shadowedProps[n]&&(e+="!(ctor && ctor.prototype === iterable) && "),e+="hasOwnProperty.call(iterable, index)) {\n    "+t.loop+"\n  }      "}return(t.arrays||F.nonEnumArgs)&&(e+="\n}"),e+=t.bottom+";\nreturn result"},W={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},z={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},V={top:"if (!objectTypes[typeof iterable]) return result;\n"+z.top,arrays:!1};F.argsClass||(s=function(t){return t?O.call(t,"callee"):!1});var D=S||function(t){return t?"object"==typeof t&&k.call(t)==g:!1},R=r({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),K=E?function(t){return l(t)?F.enumPrototypes&&"function"==typeof t||F.nonEnumArgs&&t.length&&s(t)?R(t):E(t):[]}:R,N=r(W,{top:W.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),$=r(z,V,{useHas:!1}),G=r(z,V);c(/x/)&&(c=function(t){return"function"==typeof t&&k.call(t)==v}),t.assign=N,t.bind=h,t.createCallback=p,t.forIn=$,t.forOwn=G,t.keys=K,t.extend=N,t.identity=u,t.isArguments=s,t.isArray=D,t.isEqual=o,t.isFunction=c,t.isObject=l,t.VERSION="1.2.1",t.extend(n.util,t)})();var r=Math.pow(10,-9),i=Math.pow(10,-6),a=2.99792458*Math.pow(10,8);return n.constants={um:i,nm:r,c:a},function(){function t(t){this.vertices=t,this.centroid=null,this.reflect_point=null,this.reflect_cost=null,this.expand_point=null,this.expand_cost=null,this.contract_point=null,this.contract_cost=null}function e(e,n,r){var i,a,s=new t([n,n+1,n+2]);for(i=0;r>i;i+=1)s.updateCentroid(e),s.updateReflectPoint(e),a=s.vertices[0],s.reflect_cost<s.getVertexCost(e,"secondWorst")&&s.reflect_cost>s.getVertexCost(e,"best")?s.reflect():s.reflect_cost<s.getVertexCost(e,"best")?(s.updateExpandPoint(e),s.expand_cost<s.reflect_cost?s.expand():s.reflect()):(s.updateContractPoint(e),s.contract_cost<s.getVertexCost(e,"worst")?s.contract():s.reduce())}t.prototype.sortByCost=function(t){this.vertices.sort(function(e,n){var r=t(e),i=t(n);return i>r?-1:r>i?1:0})},t.prototype.updateCentroid=function(t){this.sortByCost(t);var e,n=this.vertices.length-1,r=0;for(e=0;n>e;e+=1)r+=this.vertices[e];this.centroid=r/n},t.prototype.updateReflectPoint=function(t){var e=this.vertices[this.vertices.length-1];this.reflect_point=this.centroid+(this.centroid-e),this.reflect_cost=t(this.reflect_point)},t.prototype.updateExpandPoint=function(t){var e=this.vertices[this.vertices.length-1];this.expand_point=this.centroid+2*(this.centroid-e),this.expand_cost=t(this.expand_point)},t.prototype.updateContractPoint=function(t){var e=this.vertices[this.vertices.length-1];this.contract_point=this.centroid+.5*(this.centroid-e),this.contract_cost=t(this.contract_point)},t.prototype.getVertexCost=function(t,e){return"worst"===e?t(this.vertices[this.vertices.length-1]):"secondWorst"===e?t(this.vertices[this.vertices.length-2]):"best"===e?t(this.vertices[0]):void 0},t.prototype.reflect=function(){this.vertices[this.vertices.length-1]=this.reflect_point},t.prototype.expand=function(){this.vertices[this.vertices.length-1]=this.expand_point},t.prototype.contract=function(){this.vertices[this.vertices.length-1]=this.contract_point},t.prototype.reduce=function(){var t,e=this.vertices[0];for(t=1;this.vertices.length>t;t+=1)this.vertices[t]=e+.5*(this.vertices[t]-e)},n.nelderMead=e}(),n.BBO=function(t){this.temp=t},n.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var n=Math.sqrt(2.7359+.01878/(e(t)-.01822)-.01354*e(t)),r=Math.sqrt(2.3753+.01224/(e(t)-.01667)-.01516*e(t));return[n,n,r]}},n.calc_delK=function(t){var e=t.n_p,n=t.n_s,r=t.n_i,i=[Math.sin(t.theta_s)*Math.cos(t.phi_s),Math.sin(t.theta_s)*Math.sin(t.phi_s),Math.cos(t.theta_s)],a=[Math.sin(t.theta_i)*Math.cos(t.phi_i),Math.sin(t.theta_i)*Math.sin(t.phi_i),Math.cos(t.theta_i)],s=2*Math.PI*(n*i[0]/t.lambda_s+r*a[0]/t.lambda_i),o=2*Math.PI*(n*i[1]/t.lambda_s+r*a[1]/t.lambda_i),c=2*Math.PI*(e/t.lambda_p-n*i[2]/t.lambda_s-r*a[2]/t.lambda_i);return c-=2*Math.PI/t.poling_period,[s,o,c]},n.optimum_idler=function(t,r,i,a,s,o,c,l,h){var p=1/(1/i-1/a),u=o+Math.PI,f=a/h,d=n.GetPMTypeIndices(t,r,i,a,p,c,l,s,s,o,u),_=d[0];d[1];var b=d[2],g=e(_)+e(b*a/i);g-=2*_*b*(a/i)*Math.cos(s)-2*b*a/i*f,g+=2*_*Math.cos(s)*f+e(f),g=Math.sqrt(g);var y=_*Math.sin(s)/g,m=Math.asin(y);return m},n.phasematch=function(t){t.lambda_p,t.n_p,t.lambda_p=1/(1/t.lambda_s+1/t.lambda_i),t.n_p=t.calc_Index_PMType(t.lambda_p,t.Type,t.S_p,"pump");var r=n.calc_delK(t),i=t.L/2*r[2],a=Math.sin(i)/i,s=a*Math.cos(i),o=a*Math.sin(i),c=Math.exp(-.5*(e(r[0])+e(r[1]))*e(t.W)),l=1;return[l*c*s,l*c*o]},n.phasematch_Int_Phase=function(t){var r=n.phasematch(t,t.crystal,t.Type,t.lambda_p,t.p_bw,t.W,t.lambda_s,t.lambda_i,t.L,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i,t.poling_period,t.phase,t.apodization,t.apodization_FWHM);return t.phase?Math.atan2(r[1],r[0])+Math.PI:r=e(r[0])+e(r[1]),r},function(){var t=n.constants,r={lambda_p:775*t.nm,lambda_s:1500*t.nm,lambda_i:1600*t.nm,Type:["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],theta:19.8371104525*Math.PI/180,phi:0,theta_s:0,theta_i:0,phi_s:0,phi_i:0,poling_period:1e6,L:2e4*t.um,W:500*t.um,p_bw:1,phase:!1,apodization:1,apodization_FWHM:1e3*t.um},i=function(t){this.init(t||r)};i.prototype={init:function(){var t=n.constants;this.lambda_p=775*t.nm,this.lambda_s=1550*t.nm,this.lambda_i=1550*t.nm,this.Types=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.Type=this.Types[1],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.crystal=new n.BBO,this.S_p=this.calc_Coordinate_Transform(this.theta,this.phi,0,0),this.S_s=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_s,this.phi_s),this.S_i=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_i,this.phi_i),this.n_p=this.calc_Index_PMType(this.lambda_p,this.Type,this.S_p,"pump"),this.n_s=this.calc_Index_PMType(this.lambda_s,this.Type,this.S_s,"signal"),this.n_i=this.calc_Index_PMType(this.lambda_i,this.Type,this.S_i,"idler")},calc_Coordinate_Transform:function(t,n,r,i){var a=Math.sin(t),s=Math.cos(t),o=Math.sin(r),c=Math.cos(r),l=Math.sin(n),h=Math.cos(n),p=Math.sin(i),u=Math.cos(i),f=o*u,d=o*p,_=c,b=s*h*f-l*d+a*h*_,g=s*l*f+h*d+a*l*_,y=-a*f+s*_,m=Math.sqrt(e(f)+e(d)+e(_)),v=b/m,x=g/m,M=y/m;return[v,x,M]},calc_Index_PMType:function(t,n,r,i){var a=this.crystal.indicies(t),s=a[0],o=a[1],c=a[2],l=r[0],h=r[1],p=r[2],u=e(l)*(1/e(o)+1/e(c))+e(h)*(1/e(s)+1/e(c))+e(p)*(1/e(s)+1/e(o)),f=e(l)/(e(o)*e(c))+e(h)/(e(s)*e(c))+e(p)/(e(s)*e(o)),d=e(u)-4*f,_=Math.sqrt(2/(u+Math.sqrt(d))),b=Math.sqrt(2/(u-Math.sqrt(d))),g=1;switch(n){case"e -> o + o":g="pump"===i?_:b;break;case"e -> e + o":g="idler"===i?b:_;break;case"e -> o + e":g="signal"===i?b:_;break;default:throw"Error: bad PMType specified"}return g},set:function(t,e){switch(this[t]=e,t){case"theta":case"phi":case"theta_s":case"phi_s":this.S.set(this.theta,this.phi,this.theta_s,this.phi_s)}return this}},n.SPDCprop=i}(),n.calcJSA=function(e,r,i,a,s,o){var c,l=new Float64Array(o),h=new Float64Array(o);l=t.linspace(r,i,o),h=t.linspace(s,a,o);var p=o*o,u=new Float64Array(p);for(new Date,c=0;p>c;c++){var f=c%o,d=Math.floor(c/o);e.lambda_s=l[f],e.lambda_i=h[d],e.n_s=e.calc_Index_PMType(e.lambda_s,e.Type,e.S_s,"signal"),e.n_i=e.calc_Index_PMType(e.lambda_i,e.Type,e.S_i,"idler"),u[c]=n.phasematch_Int_Phase(e)}return new Date,u},n});