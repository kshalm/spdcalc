(function(t,e){"object"==typeof exports?module.exports=e(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],e):t.PhaseMatch=e(t.numeric)})(this,function(t){"use strict";function e(t){return t*t}var n={util:{}};(function(){function t(){}function e(t,e,n,a){function r(){var a=arguments,c=o?this:e;if(s||(t=e[h]),n.length&&(a=a.length?(a=L.call(a),u?a.concat(n):n.concat(a)):n),this instanceof r){i.prototype=t.prototype,c=new i,i.prototype=null;var p=t.apply(c,a);return l(p)?p:c}return t.apply(c,a)}var s=c(t),o=!n,h=e;if(o){var u=a;n=e}else if(!s){if(!a)throw new TypeError;e=t}return r}function a(){for(var e,n={shadowedProps:_,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!R},a=0;e=arguments[a];a++)for(var r in e)n[r]=e[r];var i=n.args;n.firstArg=/^[^,]+/.exec(i)[0];var o=Function("hasOwnProperty, isArguments, isArray, keys, lodash, objectTypes","return function("+i+") {\n"+B(n)+"\n}");return o(k,s,D,R,t,j)}function r(t){return"function"!=typeof t.toString&&"string"==typeof(t+"")}function i(){}function s(t){return A.call(t)==b}function o(e,n,a,i,l,h){var u=a===d;if("function"==typeof a&&!u){a=t.createCallback(a,i,2);var p=a(e,n);if(p!==undefined)return!!p}if(e===n)return 0!==e||1/e==1/n;var f=typeof e,_=typeof n;if(e===e&&(!e||"function"!=f&&"object"!=f)&&(!n||"function"!=_&&"object"!=_))return!1;if(null==e||null==n)return e===n;var M=A.call(e),j=A.call(n);if(M==b&&(M=w),j==b&&(j=w),M!=j)return!1;switch(M){case m:case y:return+e==+n;case v:return e!=+e?n!=+n:0==e?1/e==1/n:e==+n;case x:case P:return e==n+""}var T=M==g;if(!T){if(k.call(e,"__wrapped__ ")||k.call(n,"__wrapped__"))return o(e.__wrapped__||e,n.__wrapped__||n,a,i,l,h);if(M!=w||!H.nodeClass&&(r(e)||r(n)))return!1;var I=!H.argsObject&&s(e)?Object:e.constructor,O=!H.argsObject&&s(n)?Object:n.constructor;if(I!=O&&!(c(I)&&I instanceof I&&c(O)&&O instanceof O))return!1}l||(l=[]),h||(h=[]);for(var S=l.length;S--;)if(l[S]==e)return h[S]==n;var C=0;if(p=!0,l.push(e),h.push(n),T){if(S=e.length,C=n.length,p=C==e.length,!p&&!u)return p;for(;C--;){var E=S,L=n[C];if(u)for(;E--&&!(p=o(e[E],L,a,i,l,h)););else if(!(p=o(e[C],L,a,i,l,h)))break}return p}return G(n,function(t,n,r){return k.call(r,n)?(C++,p=k.call(e,n)&&o(e[n],t,a,i,l,h)):undefined}),p&&!u&&G(e,function(t,e,n){return k.call(n,e)?p=--C>-1:undefined}),p}function c(t){return"function"==typeof t}function l(t){return t?j[typeof t]:!1}function h(t,n){return H.fastBind||S&&arguments.length>2?S.call.apply(S,arguments):e(t,n,L.call(arguments,2))}function u(t,e,n){if(null==t)return p;var a=typeof t;if("function"!=a){if("object"!=a)return function(e){return e[t]};var r=R(t);return function(e){for(var n=r.length,a=!1;n--&&(a=o(e[r[n]],t[r[n]],d)););return a}}return e!==undefined?1===n?function(n){return t.call(e,n)}:2===n?function(n,a){return t.call(e,n,a)}:4===n?function(n,a,r,i){return t.call(e,n,a,r,i)}:function(n,a,r){return t.call(e,n,a,r)}:t}function p(t){return t}var f="object"==typeof global&&global;(f.global===f||f.window===f)&&(window=f);var d={};+new Date+"";var _=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],b="[object Arguments]",g="[object Array]",m="[object Boolean]",y="[object Date]",M="[object Function]",v="[object Number]",w="[object Object]",x="[object RegExp]",P="[object String]",j={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},T=[],I={};window._;var O=RegExp("^"+(I.valueOf+"").replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),k=(Math.ceil,window.clearTimeout,T.concat,Math.floor,I.hasOwnProperty),A=(T.push,window.setTimeout,I.toString),S=O.test(S=A.bind)&&S,C=O.test(C=Array.isArray)&&C,E=(window.isFinite,window.isNaN,O.test(E=Object.keys)&&E),L=(Math.max,Math.min,Math.random,T.slice),q=O.test(window.attachEvent),F=S&&!/\n|true/.test(S+q),H=t.support={};(function(){var t=function(){this.x=1},e=[];t.prototype={valueOf:1,y:1};for(var n in new t)e.push(n);for(n in arguments);H.argsObject=arguments.constructor==Object&&!(arguments instanceof Array),H.argsClass=s(arguments),H.enumPrototypes=t.propertyIsEnumerable("prototype"),H.fastBind=S&&!F,H.nonEnumArgs=0!=n,H.nonEnumShadows=!/valueOf/.test(e),H.unindexedChars="xx"!="x"[0]+Object("x")[0];try{H.nodeClass=!(A.call(document)==w&&!({toString:0}+""))}catch(a){H.nodeClass=!0}})(1);var B=function(t){var e="var index, iterable = "+t.firstArg+", result = "+t.init+";\nif (!iterable) return result;\n"+t.top+";\n";if(t.arrays?(e+="var length = iterable.length; index = -1;\nif ("+t.arrays+") {  ",H.unindexedChars&&(e+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),e+="\n  while (++index < length) {\n    "+t.loop+"\n  }\n}\nelse {  "):H.nonEnumArgs&&(e+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+t.loop+"\n    }\n  } else {  "),H.enumPrototypes&&(e+="\n  var skipProto = typeof iterable == 'function';\n  "),t.useHas&&t.useKeys)e+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",H.enumPrototypes&&(e+="if (!(skipProto && index == 'prototype')) {\n  "),e+=t.loop,H.enumPrototypes&&(e+="}\n"),e+="  }  ";else if(e+="\n  for (index in iterable) {",(H.enumPrototypes||t.useHas)&&(e+="\n    if (",H.enumPrototypes&&(e+="!(skipProto && index == 'prototype')"),H.enumPrototypes&&t.useHas&&(e+=" && "),t.useHas&&(e+="hasOwnProperty.call(iterable, index)"),e+=") {    "),e+=t.loop+";    ",(H.enumPrototypes||t.useHas)&&(e+="\n    }"),e+="\n  }    ",H.nonEnumShadows){e+="\n\n  var ctor = iterable.constructor;\n      ";for(var n=0;7>n;n++)e+="\n  index = '"+t.shadowedProps[n]+"';\n  if (","constructor"==t.shadowedProps[n]&&(e+="!(ctor && ctor.prototype === iterable) && "),e+="hasOwnProperty.call(iterable, index)) {\n    "+t.loop+"\n  }      "}return(t.arrays||H.nonEnumArgs)&&(e+="\n}"),e+=t.bottom+";\nreturn result"},W={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},z={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},K={top:"if (!objectTypes[typeof iterable]) return result;\n"+z.top,arrays:!1};H.argsClass||(s=function(t){return t?k.call(t,"callee"):!1});var D=C||function(t){return t?"object"==typeof t&&A.call(t)==g:!1},N=a({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),R=E?function(t){return l(t)?H.enumPrototypes&&"function"==typeof t||H.nonEnumArgs&&t.length&&s(t)?N(t):E(t):[]}:N,$=a(W,{top:W.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),G=a(z,K,{useHas:!1}),J=a(z,K);c(/x/)&&(c=function(t){return"function"==typeof t&&A.call(t)==M}),t.assign=$,t.bind=h,t.createCallback=u,t.forIn=G,t.forOwn=J,t.keys=R,t.extend=$,t.identity=p,t.isArguments=s,t.isArray=D,t.isEqual=o,t.isFunction=c,t.isObject=l,t.VERSION="1.2.1",t.extend(n.util,t)})();var a=Math.pow(10,-9),r=Math.pow(10,-6),i=2.99792458*Math.pow(10,8);return n.constants={um:r,nm:a,c:i},n.BBO=function(t){this.temp=t},n.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var n=Math.sqrt(2.7359+.01878/(e(t)-.01822)-.01354*e(t)),a=Math.sqrt(2.3753+.01224/(e(t)-.01667)-.01516*e(t));return[n,n,a]}},n.calc_delK=function(t){var e=t.n_p,n=t.n_s,a=t.n_i,r=[Math.sin(t.theta_s)*Math.cos(t.phi_s),Math.sin(t.theta_s)*Math.sin(t.phi_s),Math.cos(t.theta_s)],i=[Math.sin(t.theta_i)*Math.cos(t.phi_i),Math.sin(t.theta_i)*Math.sin(t.phi_i),Math.cos(t.theta_i)],s=2*Math.PI*(n*r[0]/t.lambda_s+a*i[0]/t.lambda_i),o=2*Math.PI*(n*r[1]/t.lambda_s+a*i[1]/t.lambda_i),c=2*Math.PI*(e/t.lambda_p-n*r[2]/t.lambda_s-a*i[2]/t.lambda_i);return c-=2*Math.PI/t.poling_period,[s,o,c]},n.optimum_idler=function(t,a,r,i,s,o,c,l,h){var u=1/(1/r-1/i),p=o+Math.PI,f=i/h,d=n.GetPMTypeIndices(t,a,r,i,u,c,l,s,s,o,p),_=d[0];d[1];var b=d[2],g=e(_)+e(b*i/r);g-=2*_*b*(i/r)*Math.cos(s)-2*b*i/r*f,g+=2*_*Math.cos(s)*f+e(f),g=Math.sqrt(g);var m=_*Math.sin(s)/g,y=Math.asin(m);return y},n.phasematch=function(t){t.lambda_p,t.n_p,t.lambda_p=1/(1/t.lambda_s+1/t.lambda_i),t.n_p=t.calc_Index_PMType(t.lambda_p,t.Type,t.S_p,"pump");var a=n.calc_delK(t),r=t.L/2*a[2],i=Math.sin(r)/r,s=i*Math.cos(r),o=i*Math.sin(r),c=Math.exp(-.5*(e(a[0])+e(a[1]))*e(t.W)),l=1;return[l*c*s,l*c*o]},n.phasematch_Int_Phase=function(t){var a=n.phasematch(t,t.crystal,t.Type,t.lambda_p,t.p_bw,t.W,t.lambda_s,t.lambda_i,t.L,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i,t.poling_period,t.phase,t.apodization,t.apodization_FWHM);return t.phase?Math.atan2(a[1],a[0])+Math.PI:a=e(a[0])+e(a[1]),a},function(){var a=n.constants,r={lambda_p:775*a.nm,lambda_s:1500*a.nm,lambda_i:1600*a.nm,Type:["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],theta:19.8371104525*Math.PI/180,phi:0,theta_s:0,theta_i:0,phi_s:0,phi_i:0,poling_period:1e6,L:2e4*a.um,W:500*a.um,p_bw:1,phase:!1,apodization:1,apodization_FWHM:1e3*a.um},i=function(t){this.init(t||r)};i.prototype={init:function(){var t=n.constants;this.lambda_p=775*t.nm,this.lambda_s=1550*t.nm,this.lambda_i=1550*t.nm,this.Types=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.Type=this.Types[1],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.crystal=new n.BBO,this.S_p=this.calc_Coordinate_Transform(this.theta,this.phi,0,0),this.S_s=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_s,this.phi_s),this.S_i=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_i,this.phi_i),this.n_p=this.calc_Index_PMType(this.lambda_p,this.Type,this.S_p,"pump"),this.n_s=this.calc_Index_PMType(this.lambda_s,this.Type,this.S_s,"signal"),this.n_i=this.calc_Index_PMType(this.lambda_i,this.Type,this.S_i,"idler"),this.msg=""},calc_Coordinate_Transform:function(t,n,a,r){var i=Math.sin(t),s=Math.cos(t),o=Math.sin(a),c=Math.cos(a),l=Math.sin(n),h=Math.cos(n),u=Math.sin(r),p=Math.cos(r),f=o*p,d=o*u,_=c,b=s*h*f-l*d+i*h*_,g=s*l*f+h*d+i*l*_,m=-i*f+s*_,y=Math.sqrt(e(f)+e(d)+e(_)),M=b/y,v=g/y,w=m/y;return[M,v,w]},calc_Index_PMType:function(t,n,a,r){var i=this.crystal.indicies(t),s=i[0],o=i[1],c=i[2],l=a[0],h=a[1],u=a[2],p=e(l)*(1/e(o)+1/e(c))+e(h)*(1/e(s)+1/e(c))+e(u)*(1/e(s)+1/e(o)),f=e(l)/(e(o)*e(c))+e(h)/(e(s)*e(c))+e(u)/(e(s)*e(o)),d=e(p)-4*f,_=Math.sqrt(2/(p+Math.sqrt(d))),b=Math.sqrt(2/(p-Math.sqrt(d))),g=1;switch(n){case"e -> o + o":g="pump"===r?_:b;break;case"e -> e + o":g="idler"===r?b:_;break;case"e -> o + e":g="signal"===r?b:_;break;default:throw"Error: bad PMType specified"}return g},set:function(t,e){switch(this[t]=e,t){case"theta":case"phi":case"theta_s":case"phi_s":this.S.set(this.theta,this.phi,this.theta_s,this.phi_s)}return this}},n.SPDCprop=i,n.auto_calc_Theta=function(a){a.msg="before min_delK";var r=function(t){a.theta=t[0],a.msg="going in";var r=n.calc_delK(a);return Math.sqrt(e(r[0])+e(r[1])+e(r[2]))};a.theta=r(1);var i=function(t){return e(-13+t[0]+((5-t[1])*t[1]-2)*t[1])+e(-29+t[0]+((t[1]+1)*t[1]-14)*t[1])};a.theta=t.uncmin(i,[.5,-2]).solution[1]}}(),n.calcJSA=function(e,a,r,i,s,o){var c,l=new Float64Array(o),h=new Float64Array(o);l=t.linspace(a,r,o),h=t.linspace(s,i,o);var u=o*o,p=new Float64Array(u);for(new Date,c=0;u>c;c++){var f=c%o,d=Math.floor(c/o);e.lambda_s=l[f],e.lambda_i=h[d],e.n_s=e.calc_Index_PMType(e.lambda_s,e.Type,e.S_s,"signal"),e.n_i=e.calc_Index_PMType(e.lambda_i,e.Type,e.S_i,"idler"),p[c]=n.phasematch_Int_Phase(e)}return new Date,p},n});