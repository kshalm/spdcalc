(function(t,a){"object"==typeof exports?module.exports=a(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],a):t.PhaseMatch=a(t.numeric)})(this,function(t){"use strict";function a(t){return t*t}var i={},s=Math.pow(10,-9),h=Math.pow(10,-6),e=2.99792458*Math.pow(10,8);return i.constants={um:h,nm:s,c:e},i.BBO=function(t){this.temp=t},i.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var i=Math.sqrt(2.7359+.01878/(a(t)-.01822)-.01354*a(t)),s=Math.sqrt(2.3753+.01224/(a(t)-.01667)-.01516*a(t));return[i,i,s]}},i.calc_delK=function(t){var a=t.n_p,i=t.n_s,s=t.n_i,h=[Math.sin(t.theta_s)*Math.cos(t.phi_s),Math.sin(t.theta_s)*Math.sin(t.phi_s),Math.cos(t.theta_s)],e=[Math.sin(t.theta_i)*Math.cos(t.phi_i),Math.sin(t.theta_i)*Math.sin(t.phi_i),Math.cos(t.theta_i)],n=2*Math.PI*(i*h[0]/t.lambda_s+s*e[0]/t.lambda_i),_=2*Math.PI*(i*h[1]/t.lambda_s+s*e[1]/t.lambda_i),p=2*Math.PI*(a/t.lambda_p-i*h[2]/t.lambda_s-s*e[2]/t.lambda_i);return p-=2*Math.PI/t.poling_period,[n,_,p]},i.optimum_idler=function(t,s,h,e,n,_,p,o,r){var c=1/(1/h-1/e),l=_+Math.PI,d=e/r,M=i.GetPMTypeIndices(t,s,h,e,c,p,o,n,n,_,l),m=M[0];M[1];var u=M[2],b=a(m)+a(u*e/h);b-=2*m*u*(e/h)*Math.cos(n)-2*u*e/h*d,b+=2*m*Math.cos(n)*d+a(d),b=Math.sqrt(b);var f=m*Math.sin(n)/b,y=Math.asin(f);return y},i.phasematch=function(t){t.lambda_p,t.n_p,t.lambda_p=1/(1/t.lambda_s+1/t.lambda_i),t.n_p=t.calc_Index_PMType(t.lambda_p,t.Type,t.S_p,"pump");var s=i.calc_delK(t),h=t.L/2*s[2],e=Math.sin(h)/h,n=e*Math.cos(h),_=e*Math.sin(h),p=Math.exp(-.5*(a(s[0])+a(s[1]))*a(t.W)),o=1;return[o*p*n,o*p*_]},i.phasematch_Int_Phase=function(t){var s=i.phasematch(t,t.crystal,t.Type,t.lambda_p,t.p_bw,t.W,t.lambda_s,t.lambda_i,t.L,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i,t.poling_period,t.phase,t.apodization,t.apodization_FWHM);return t.phase?Math.atan2(s[1],s[0])+Math.PI:s=a(s[0])+a(s[1]),s},function(){var t=function(){this.init()};t.prototype={init:function(){var t=i.constants;this.lambda_p=775*t.nm,this.lambda_s=1550*t.nm,this.lambda_i=1550*t.nm,this.Types=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.Type=this.Types[1],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.crystal=new i.BBO,this.S_p=this.calc_Coordinate_Transform(this.theta,this.phi,0,0),this.S_s=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_s,this.phi_s),this.S_i=this.calc_Coordinate_Transform(this.theta,this.phi,this.theta_i,this.phi_i),this.n_p=this.calc_Index_PMType(this.lambda_p,this.Type,this.S_p,"pump"),this.n_s=this.calc_Index_PMType(this.lambda_s,this.Type,this.S_s,"signal"),this.n_i=this.calc_Index_PMType(this.lambda_i,this.Type,this.S_i,"idler")},calc_Coordinate_Transform:function(t,i,s,h){var e=Math.sin(t),n=Math.cos(t),_=Math.sin(s),p=Math.cos(s),o=Math.sin(i),r=Math.cos(i),c=Math.sin(h),l=Math.cos(h),d=_*l,M=_*c,m=p,u=n*r*d-o*M+e*r*m,b=n*o*d+r*M+e*o*m,f=-e*d+n*m,y=Math.sqrt(a(d)+a(M)+a(m)),T=u/y,P=b/y,I=f/y;return[T,P,I]},calc_Index_PMType:function(t,i,s,h){var e=this.crystal.indicies(t),n=e[0],_=e[1],p=e[2],o=s[0],r=s[1],c=s[2],l=a(o)*(1/a(_)+1/a(p))+a(r)*(1/a(n)+1/a(p))+a(c)*(1/a(n)+1/a(_)),d=a(o)/(a(_)*a(p))+a(r)/(a(n)*a(p))+a(c)/(a(n)*a(_)),M=a(l)-4*d,m=Math.sqrt(2/(l+Math.sqrt(M))),u=Math.sqrt(2/(l-Math.sqrt(M))),b=1;switch(i){case"e -> o + o":b="pump"===h?m:u;break;case"e -> e + o":b="idler"===h?u:m;break;case"e -> o + e":b="signal"===h?u:m;break;default:throw"Error: bad PMType specified"}return b},set:function(t,a){switch(t){case"lambda_p":}this[t]=a}},i.SPDCprop=t}(),i.calcJSA=function(a,s,h,e,n,_){var p,o=new Float64Array(_),r=new Float64Array(_);o=t.linspace(s,h,_),r=t.linspace(n,e,_);var c=new Float64Array(_*_),l=_*_;for(new Date,p=0;l>p;p++){var d=p%_,M=Math.floor(p/_);a.lambda_s=o[d],a.lambda_i=r[M],a.n_s=a.calc_Index_PMType(a.lambda_s,a.Type,a.S_s,"signal"),a.n_i=a.calc_Index_PMType(a.lambda_i,a.Type,a.S_i,"idler"),c[p]=i.phasematch_Int_Phase(a)}return new Date,c},i});