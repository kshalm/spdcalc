(function(t,a){"object"==typeof exports?module.exports=a(require("numeric")):"function"==typeof define&&define.amd?define(["numeric"],a):t.PhaseMatch=a(t.numeric)})(this,function(t){"use strict";function a(t){return t*t}var s={},i=Math.pow(10,-9),h=Math.pow(10,-6),n=2.99792458*Math.pow(10,8);return s.constants={um:h,nm:i,c:n},s.BBO=function(t){this.temp=t},s.BBO.prototype={indicies:function(t){t*=Math.pow(10,6);var s=Math.sqrt(2.7359+.01878/(a(t)-.01822)-.01354*a(t)),i=Math.sqrt(2.3753+.01224/(a(t)-.01667)-.01516*a(t));return[s,s,i]}},s.GetIndices=function(t,s,i,h,n,e){var o=t.indicies(s),c=o[0],r=o[1],M=o[2],p=Math.sin(n)*Math.cos(e),_=Math.sin(n)*Math.sin(e),u=Math.cos(n),d=Math.cos(i)*Math.cos(h)*p-Math.sin(h)*_+Math.sin(i)*Math.cos(h)*u,m=Math.cos(i)*Math.sin(h)*p+Math.cos(h)*_+Math.sin(i)*Math.sin(h)*u,l=-Math.sin(i)*p+Math.cos(i)*u,f=Math.sqrt(a(p)+a(_)+a(u)),b=d/f,y=m/f,v=l/f,I=a(b)*(1/a(r)+1/a(M))+a(y)*(1/a(c)+1/a(M))+a(v)*(1/a(c)+1/a(r)),w=a(b)/(a(r)*a(M))+a(y)/(a(c)*a(M))+a(v)/(a(c)*a(r)),P=a(I)-4*w,q=Math.sqrt(2/(I+Math.sqrt(P))),S=Math.sqrt(2/(I-Math.sqrt(P)));return[S,q]},s.GetPMTypeIndices=function(t,a,i,h,n,e,o,c,r,M,p){var _,u,d,m=s.GetIndices(t,h,e,o,c,M),l=s.GetIndices(t,n,e,o,r,p),f=s.GetIndices(t,i,e,o,0,0);switch(a){case"e -> o + o":_=m[0],u=l[0],d=f[1];break;case"e -> e + o":_=m[1],u=l[0],d=f[1];break;case"e -> o + e":_=m[0],u=l[1],d=f[1];break;default:throw"Error: bad PMType specified"}return[_,u,d]},s.spdc_to_pump_coordinates=function(t,a){return[Math.sin(t)*Math.cos(a),Math.sin(t)*Math.sin(a),Math.cos(t)]},s.calc_delK=function(t){var a=s.GetPMTypeIndices(t.crystal,t.Type,t.lambda_p,t.lambda_s,t.lambda_i,t.theta,t.phi,t.theta_s,t.theta_i,t.phi_s,t.phi_i),i=a[0],h=a[1],n=a[2],e=[Math.sin(t.theta_s)*Math.cos(t.phi_s),Math.sin(t.theta_s)*Math.sin(t.phi_s),Math.cos(t.theta_s)],o=[Math.sin(t.theta_i)*Math.cos(t.phi_i),Math.sin(t.theta_i)*Math.sin(t.phi_i),Math.cos(t.theta_i)],c=2*Math.PI*(i*e[0]/t.lambda_s+h*o[0]/t.lambda_i),r=2*Math.PI*(i*e[1]/t.lambda_s+h*o[1]/t.lambda_i),M=2*Math.PI*(n/t.lambda_p-i*e[2]/t.lambda_s-h*o[2]/t.lambda_i);return M-=2*Math.PI/t.poling_period,[c,r,M]},s.optimum_idler=function(t,i,h,n,e,o,c,r,M){var p=1/(1/h-1/n),_=o+Math.PI,u=n/M,d=s.GetPMTypeIndices(t,i,h,n,p,c,r,e,e,o,_),m=d[0];d[1];var l=d[2],f=a(m)+a(l*n/h);f-=2*m*l*(n/h)*Math.cos(e)-2*l*n/h*u,f+=2*m*Math.cos(e)*u+a(u),f=Math.sqrt(f);var b=m*Math.sin(e)/f,y=Math.asin(b);return y},s.phasematch=function(t){1/(1/t.lambda_s+1/t.lambda_i);var i=s.calc_delK(t),h=t.L/2*i[2],n=Math.sin(h)/h,e=n*Math.cos(h),o=n*Math.sin(h),c=Math.exp(-.5*(a(i[0])+a(i[1]))*a(t.W)),r=1;return[r*c*e,r*c*o]},s.phasematch_Int_Phase=function(t){var i=s.phasematch(t);return t.phase?Math.atan2(i[1],i[0])+Math.PI:i=a(i[0])+a(i[1]),i},function(){var t=function(){this.Sx=0,this.Sy=0,this.Sz=0};t.prototype={set:function(t,s,i,h){var n=Math.sin(i)*Math.cos(h),e=Math.sin(i)*Math.sin(h),o=Math.cos(i),c=Math.cos(t)*Math.cos(s)*n-Math.sin(s)*e+Math.sin(t)*Math.cos(s)*o,r=Math.cos(t)*Math.sin(s)*n+Math.cos(s)*e+Math.sin(t)*Math.sin(s)*o,M=-Math.sin(t)*n+Math.cos(t)*o,p=Math.sqrt(a(n)+a(e)+a(o));this.Sx=c/p,this.Sy=r/p,this.Sz=M/p}},s.Rotation=t;var i=function(){this.init()};i.prototype={init:function(){var t=s.constants;this.lambda_p=775*t.nm,this.lambda_s=1550*t.nm,this.lambda_i=1550*t.nm,this.Types=["o -> o + o","e -> o + o","e -> e + o","e -> o + e"],this.Type=this.Types[1],this.theta=19.8371104525*Math.PI/180,this.phi=0,this.theta_s=0,this.theta_i=0,this.phi_s=0,this.phi_i=0,this.poling_period=1e6,this.L=2e4*t.um,this.W=500*t.um,this.p_bw=1,this.phase=!1,this.apodization=1,this.apodization_FWHM=1e3*t.um,this.crystal=new s.BBO},set:function(t,a){switch(t){case"lambda_p":}this[t]=a}},s.SPDCprop=i}(),s.calcJSA=function(a,i,h,n,e,o){var c,r=new Float64Array(o),M=new Float64Array(o);r=t.linspace(i,h,o),M=t.linspace(e,n,o);var p=new Float64Array(o*o),_=o*o;for(new Date,c=0;_>c;c++){var u=c%o,d=Math.floor(c/o);a.lambda_s=r[u],a.lambda_i=M[d],p[c]=s.phasematch_Int_Phase(a)}return new Date,p},s.linspace=function(t,a,s){for(var i=(a-t)/s,h=new Float64Array(s),n=0;s>n;n++)h[n]=t+i*n;return h},s});